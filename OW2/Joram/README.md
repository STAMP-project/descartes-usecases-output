# Joram Descartes + DSpot experiments (KPI 1 and 3)

Synopsis:
- Run Descartes on a Joram module, to obtain statistics
- Run DSpot to generate missing tests (and gather output stats, to evaluate enhancements as computed by DSpot).
- Execute all tests (including the generated ones)
- Run Descartes again to obtain... better statistics !

KPIs concerned here are #1 ("More execution paths") and #3 ("Better test quality"):
- #1 is met thanks to 4 tests generated by DSpot, and added to the Joram test suite (+ DSpot output stats)
- #3 is met by running Descartes before and after DSpot, and evaluate enhancements.

Note: STAMP allowed Joram to fix some bugs in tests (detected by Descartes): Joram issue #313987, contents generated by Descartes ( https://gitlab.ow2.org/joram/joram/issues/313987 ).

The tests described here use Joram *before* the fix, obtained as follows:
```
git clone https://gitlab.ow2.org/joram/joram.git
git checkout 108bf73c
```
(An alternate way to obtain a Joram test version is to clone the joram project in Github STAMP group: https://github.com/STAMP-project/joram ).


Insert config for STAMP in joram/joram/mom/core/pom.xml

```
          <!--
            STAMP: (after clean install): mvn eu.stamp-project:pitmp-maven-plugin:descartes
          -->
          <plugin>
              <groupId>eu.stamp-project</groupId>
              <artifactId>pitmp-maven-plugin</artifactId>
              <version>1.3.8-SNAPSHOT</version>
              <!-- All PIT's properties can be used. -->
              <configuration>
                <mutationEngine>descartes</mutationEngine>
                <reportsDirectory>/tmp/joram-descartes</reportsDirectory>
                <outputFormats>
                  <value>HTML</value>
                  <value>JSON</value>
                  <value>METHODS</value>
                  <value>ISSUES</value>
                </outputFormats>
              </configuration>
            </plugin>
```

Build/test joram (from joram/ directory):

```
mvn clean install
```
Go in joram/mom/core and run Descartes:

```
cd joram/mom/core
mvn eu.stamp-project:pitmp-maven-plugin:descartes
```

Run DSpot:

```
mvn eu.stamp-project:dspot-maven:2.1.1-SNAPSHOT:amplify-unit-tests -Dtest-criterion=JacocoCoverageSelector -Dgenerate-new-test-class=true -Diteration=1
```

DSpot generates 4 amplified tests, with following enhancements:

```
Initial instruction coverage: 50 / 46858
0,11%
Amplification results with 1 amplified tests.
Amplified instruction coverage: 140 / 46858
0,30%

Initial instruction coverage: 188 / 46858
0,40%
Amplification results with 1 amplified tests.
Amplified instruction coverage: 223 / 46858
0,48%

Initial instruction coverage: 189 / 46858
0,40%
Amplification results with 1 amplified tests.
Amplified instruction coverage: 284 / 46858
0,61%

Initial instruction coverage: 295 / 46858
0,63%
Amplification results with 1 amplified tests.
Amplified instruction coverage: 352 / 46858
0,75%
```

Copy the new tests in the existing test base:

```
cp -r target/dspot/output/org src/test/java/
```
(Note: tests are called "Ampl*Test.java" to avoid confusion in src/test/java ...)

Run the tests:

```
mvn test
```

Then run Descartes again:

```
mvn eu.stamp-project:pitmp-maven-plugin:descartes
```

Compare the 2 descartes outputs (2 directories in joram-descartes/):
- Line Coverage, previously 4% (382/10266), is now 4% (458/10266).
- Mutation Coverage, previously 4% (38/991), is now 7% (69/991).

CLEANUP if needed:
```
rm src/test/java/org/objectweb/joram/mom/*/Ampl*.java
rm -r /tmp/joram-descartes/
```
