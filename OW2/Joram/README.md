# Joram Descartes + DSpot experiments (KPI 1 and 3)

Synopsis:
- Run Descartes on a Joram module, to obtain statistics
- Run DSpot to generate missing tests (and gather output stats, to evaluate enhancements as computed by DSpot).
- Execute all tests (including the generated ones)
- Run Descartes again to obtain... better statistics !

KPIs concerned here are #1 ("More execution paths") and #3 ("Better test quality"):
- #1 is met thanks to tests generated by DSpot, and added to the Joram test suite (+ DSpot output stats)
- #3 is met by running Descartes before and after DSpot, and evaluate enhancements.

## Results

Descartes outputs (before and after DSpot) in joram-descartes-output/ directory (2 directories, named against timestamps: the oldest is *before* DSpot, the newest *after*).

DSpot outputs in joram-dspot-output/ directory.

Roughly speaking, coverage is enhanced as follows:
- 81 % increase for mutation coverage (with DSpot, either in Jacoco or PitMutant mode)
- 10 to 19% increase for line coverage (with DSpot, respectively in PitMutant and Jacoco mode).

See next parts for result details (and how to obtain them).

## How to reproduce results

### Joram version (to clone)

Note: STAMP allowed the Joram team to fix some bugs in tests (detected by Descartes): Joram issue #313987, contents generated by Descartes ( https://gitlab.ow2.org/joram/joram/issues/313987 ).
The tests described here use Joram *before* the fix, obtained as follows:

```
git clone https://gitlab.ow2.org/joram/joram.git
cd joram/
git checkout 108bf73c
```
(An alternate way to obtain a Joram test version is to clone the joram project in Github STAMP group: https://github.com/STAMP-project/joram ).

### Experiments in Joram after cloning it

#### Descartes

Insert config for STAMP in joram/joram/mom/core/pom.xml

```
          <!--
            STAMP: (after clean install): mvn eu.stamp-project:pitmp-maven-plugin:descartes
          -->
          <plugin>
              <groupId>eu.stamp-project</groupId>
              <artifactId>pitmp-maven-plugin</artifactId>
              <version>1.3.8-SNAPSHOT</version>
              <!-- All PIT's properties can be used. -->
              <configuration>
                <mutationEngine>descartes</mutationEngine>
                <reportsDirectory>/tmp/joram-descartes</reportsDirectory>
                <outputFormats>
                  <value>HTML</value>
                  <value>JSON</value>
                  <value>METHODS</value>
                  <value>ISSUES</value>
                </outputFormats>
              </configuration>
            </plugin>
```

Build/test joram (from joram/ directory):

```
mvn clean install
```
Go in joram/mom/core and run Descartes:

```
cd joram/mom/core
mvn eu.stamp-project:pitmp-maven-plugin:descartes
```

#### DSpot + unit testing (Pit mutant coverage)

Run DSpot:

```
mvn eu.stamp-project:dspot-maven:2.1.2-SNAPSHOT:amplify-unit-tests -Dgenerate-new-test-class=true -Diteration=1
```
(Note: works with DSpot 2.1 release as well).

DSpot generates 2 amplified tests, with following enhancements:

```
Test class that has been amplified: org.objectweb.joram.mom.messages.MessageEncodingTest
The original test suite kills 38 mutants
The amplification results with 1 new tests
it kills 27 more mutants

Test class that has been amplified: org.objectweb.joram.mom.notifications.TopicForwardNotTest
The original test suite kills 38 mutants
The amplification results with 1 new tests
it kills 4 more mutants

```

Copy the new tests in the existing test base:

```
cp -r target/dspot/output/org src/test/java/
```
(Note: tests are called "Ampl*Test.java" to avoid confusion in src/test/java ...)

Run the tests:

```
mvn test
```

#### Descartes (again)

Run Descartes again:

```
mvn eu.stamp-project:pitmp-maven-plugin:descartes
```

Compare the 2 descartes outputs (2 directories in joram-descartes/):
- Line Coverage, previously 4% (382/10266), is now 4% (422/10266): increase by 10.5 %
- Mutation Coverage, previously 4% (38/991), is now 7% (69/991): increase by 81.6 %

#### CLEANUP if needed

```
rm src/test/java/org/objectweb/joram/mom/*/Ampl*.java
rm -r /tmp/joram-descartes/
mvn clean
```
(Note: "mvn clean" is necessary to remove compiled amplified tests).

## DSpot line coverage (Jacoco)

#### Descartes

See above (Descartes part) if needed. Running Descartes can be useful to gather statistics before running DSpot, then compare.

#### DSpot + unit testing (Jacoco Coverage)

Run DSpot using Jacoco:

```
mvn eu.stamp-project:dspot-maven:2.1.2-SNAPSHOT:amplify-unit-tests -Dtest-criterion=JacocoCoverageSelector -Dgenerate-new-test-class=true -Diteration=1
```
(Note: works with DSpot 2.1 release as well).

DSpot generates 4 amplified tests, with following enhancements:

```
Initial instruction coverage: 50 / 46858
0,11%
Amplification results with 1 amplified tests.
Amplified instruction coverage: 140 / 46858
0,30%

Initial instruction coverage: 188 / 46858
0,40%
Amplification results with 1 amplified tests.
Amplified instruction coverage: 223 / 46858
0,48%

Initial instruction coverage: 189 / 46858
0,40%
Amplification results with 1 amplified tests.
Amplified instruction coverage: 284 / 46858
0,61%

Initial instruction coverage: 295 / 46858
0,63%
Amplification results with 1 amplified tests.
Amplified instruction coverage: 352 / 46858
0,75%
```

Copy the new tests in the existing test base:

```
cp -r target/dspot/output/org src/test/java/
```
(Note: tests are called "Ampl*Test.java" to avoid confusion in src/test/java ...)

Run the tests:

```
mvn test
```

#### Descartes (again)

Run Descartes again:

```
mvn eu.stamp-project:pitmp-maven-plugin:descartes
```

Compare the 2 descartes outputs (2 directories in joram-descartes/):
- Line Coverage, previously 4% (382/10266), is now 4% (458/10266): increase by 19.8 %
- Mutation Coverage, previously 4% (38/991), is now 7% (69/991): increase by 81.6 %

#### CLEANUP if needed

```
rm src/test/java/org/objectweb/joram/mom/*/Ampl*.java
rm -r /tmp/joram-descartes/
mvn clean
```
(Note: "mvn clean" is necessary to remove compiled amplified tests).

